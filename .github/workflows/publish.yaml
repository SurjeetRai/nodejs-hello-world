name: Publish to GitHub Packages

on: 
  push:
    branches: [main]
    
jobs: 
  build_and_package:
    runs-on: ubuntu-latest 
    steps:
       - name: Checkout Code
         uses: actions/checkout@v4
         
       - name: Use Node.js
         uses: actions/setup-node@v4
         with:
           node-version: '20'
           registry-url: 'https://npm.pkg.github.com/'
           scope: '@solankiarpan'

       - name: Install dependencies
         run: npm install
         
       - name: Build package
         run: npm run build
         
       - name: Package the App 
         run: npm pack
         
       - name: Upload package
         uses: actions/upload-artifact@v2 
         with:
           name: package
           path: "*.tgz"
           
  publish:
    runs-on: ubuntu-latest
    name: "Publish to GitHub Packages" 
    needs: [build_and_package]
    steps:
      - name: Download package
        uses: actions/download-artifact@v2 
        with:
          name: package
          
      - name: Set up Node.js
        uses: actions/setup-node@v4 
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com/'
          scope: '@solankiarpan'
      - run: echo "registry=https://npm.pkg.github.com/@solankiarpan" >> .npmrc
          
      - run: npm publish $(ls *.tgz) 
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
